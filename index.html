<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wixdex</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    
    <main>

        <section id="deck-area">

            <div id="lrig-deck">

                <h2>Lrig Deck</h2>
                <div class="card-grid" id="lrig-deck-cards">
                </div>

            </div>

            <div id="main-deck">

                <h2>Main Deck</h2>
                <div class="card-grid" id="main-deck-cards">
                </div>

            </div>

        </section>

        <section id="card-list">

            <div id="cards-container">
            </div>

        </section>

        <section id="search-tool">
            <div id="search-box">
                <input type="text" id="search-input" placeholder="カード名で検索">
            </div>
        </section>        

    </main>

    <script>

        // タッチ開始時のY座標初期値を設定
        let touchStartY = 0;
        // 現在のカードを記録する変数
        let currentCard;
    
        // DOM読込完了時に実行
        document.addEventListener('DOMContentLoaded', () => {

            // cards.jsonを取得
            fetch('cards.json')
                .then(response => response.json())
                .then(responseData => {
                    displayCards(responseData);

                    // 検索機能の初期化
                    const searchInput = document.getElementById('search-input');
                    searchInput.addEventListener('input', () => {
                        query = searchInput.value.toLowerCase();
                        filterCards(responseData, query);
                    });
                })

                .catch(error => console.error('Error loading card data:', error));
        });
    
        // displayCards関数
        function displayCards(cards) {
            const cardsContainer = document.getElementById('cards-container');
            // 既存のカードをクリア
            cardsContainer.innerHTML = '';
            cards.forEach(card => {
                // cards-containerに追加する<div class="card">を作成
                const cardElement = document.createElement('div');
                cardElement.classList.add('card');
    
                // URLからカード画像を設定
                const cardImage = document.createElement('img');
                cardImage.src = card.image;
                // 画像が表示できなかった場合はカード名を表示
                cardImage.alt = card.name;
    
                const cardName = document.createElement('p');
                cardName.textContent = card.name;

                // カードをcards-containerに表示
                cardElement.appendChild(cardImage);
                cardElement.appendChild(cardName);
                cardsContainer.appendChild(cardElement);
    
                // カードにフリックのリスナーを追加
                cardElement.addEventListener('touchstart', handleTouchStart);
                cardElement.addEventListener('touchend', (event) => {
                    // 現在のカードを記録
                    currentCard = card; 
                    handleTouchEnd(event);
                });
            });
        }

        // 検索結果をフィルタリングして表示
        function filterCards(cards, query) {
            const filteredCards = cards.filter(card => 
                card.name.toLowerCase().includes(query) || 
                (card.subname && card.subname.toLowerCase().includes(query))
            );
            displayCards(filteredCards);
        }
    
        // handleTouchStart関数
        function handleTouchStart(event) {
            // タッチ開始時のY座標を保存
            touchStartY = event.touches[0].clientY;
        }
    
        // handleTouchEnd関数
        function handleTouchEnd(event) {
            // タッチ終了時のY座標を取得し、フリックの距離を計算
            const touchEndY = event.changedTouches[0].clientY;
            const swipeDistance = touchStartY - touchEndY;
    
            // 上方向にフリックされていた場合、addCardToDeck関数を処理
            if (swipeDistance > 50 && currentCard) {
                addCardToDeck(currentCard);
            }
        }
    
        // addCardToDeck関数
        function addCardToDeck(card) {
            // lrig-deck-cardsとmain-deck-cardsをjsで取得
            const lrigDeck = document.getElementById('lrig-deck-cards');
            const mainDeck = document.getElementById('main-deck-cards');
    
            // deckに追加する<div class="card">を作成
            const cardElement = document.createElement('div');
            cardElement.classList.add('card');
    
            // URLからカード画像を設定
            const cardImage = document.createElement('img');
            cardImage.src = card.image;
            cardImage.alt = card.name;
    
            // カード名を表示する<p>要素を作成
            const cardName = document.createElement('p');
            cardName.textContent = card.name;
    
            // dataset にカードの種類とレベルを追加
            cardElement.dataset.type = card.type[0];
            cardElement.dataset.level = card.level;
    
            // cardElementに画像と名前を追加
            cardElement.appendChild(cardImage);
            cardElement.appendChild(cardName);
    
            // カード種類の最初の要素を取得
            const cardType = card.type[0];
    
            // カードの種類に応じてデッキに追加
            if (['ルリグ', 'アシストルリグ', 'ピース', 'アーツ'].includes(cardType)) {
                if (lrigDeck.children.length >= 7) {
                    console.log(`Cannot add ${card.name} to Lrig Deck: Deck is full`);
                    return;
                }
                lrigDeck.appendChild(cardElement);
                console.log(`Added ${card.name} to Lrig Deck`);
                sortLrigDeck();
            } else if (['シグニ', 'スペル'].includes(cardType)) {
                if (mainDeck.children.length >= 40) {
                    console.log(`Cannot add ${card.name} to Main Deck: Deck is full`);
                    return;
                }
                mainDeck.appendChild(cardElement);
                console.log(`Added ${card.name} to Main Deck`);
                sortMainDeck();
            } else {
                console.log(`Card type ${cardType} is not recognized`);
            }
    
            // ルリグデッキとメインデッキのカードに削除のフリックイベントを追加
            cardElement.addEventListener('touchstart', handleTouchStart);
            cardElement.addEventListener('touchend', handleRemoveTouchEnd);
        }
    
        // デッキからカードを削除する関数
        function removeCardFromDeck(cardElement) {
            const lrigDeck = document.getElementById('lrig-deck-cards');
            const mainDeck = document.getElementById('main-deck-cards');
    
            if (lrigDeck.contains(cardElement)) {
                lrigDeck.removeChild(cardElement);
                console.log('Card removed from Lrig Deck');
                sortLrigDeck();
            } else if (mainDeck.contains(cardElement)) {
                mainDeck.removeChild(cardElement);
                console.log('Card removed from Main Deck');
                sortMainDeck();
            }
        }
    
        // 削除用のhandleTouchEnd関数
        function handleRemoveTouchEnd(event) {
            // タッチ終了時のY座標を取得し、フリックの距離を計算
            const touchEndY = event.changedTouches[0].clientY;
            const swipeDistance = touchEndY - touchStartY;
    
            // 下方向にスワイプされた場合、カードを削除
            if (swipeDistance > 50 && event.currentTarget) {
                removeCardFromDeck(event.currentTarget);
            }
        }
    
        // ルリグデッキをソートする関数
        function sortLrigDeck() {
            const lrigDeck = document.getElementById('lrig-deck-cards');
            const cardElements = Array.from(lrigDeck.children);
    
            // デバッグ: ソート前のカード情報
            console.log('Before sorting Lrig Deck:', cardElements.map(card => card.querySelector('p').textContent));
    
            const order = {
                'ルリグ': 1,
                'アシストルリグ': 2,
                'ピース': 3,
                'アーツ': 4
            };
    
            cardElements.sort((a, b) => {
                const aType = order[a.dataset.type] || 5;
                const bType = order[b.dataset.type] || 5;
    
                // デバッグ: 各カードの種類を表示
                console.log('aType:', aType, 'bType:', bType);
    
                return aType - bType;
            });
    
            lrigDeck.innerHTML = '';
            cardElements.forEach(element => lrigDeck.appendChild(element));
    
            // デバッグ: ソート後のカード情報
            console.log('After sorting Lrig Deck:', Array.from(lrigDeck.children).map(card => card.querySelector('p').textContent));
        }
    
        // メインデッキをソートする関数
        function sortMainDeck() {
            const mainDeck = document.getElementById('main-deck-cards');
            const cardElements = Array.from(mainDeck.children);

            // デバッグ: ソート前のカード情報
            console.log('Before sorting Main Deck:', cardElements.map(card => ({
                name: card.querySelector('p').textContent,
                type: card.dataset.type,
                level: card.dataset.level
            })));

            const order = {
                'シグニ': 1,
                'スペル': 2
            };

            cardElements.sort((a, b) => {
                const aType = order[a.dataset.type] || 3;
                const bType = order[b.dataset.type] || 3;

                if (aType !== bType) {
                return aType - bType;
                }

                // デバッグ: レベルと名前を確認
                const aLevel = parseInt(a.dataset.level, 10);
                const bLevel = parseInt(b.dataset.level, 10);
                console.log('aLevel:', aLevel, 'bLevel:', bLevel);

                if (aLevel !== bLevel) {
                return aLevel - bLevel;
                }

                // レベルが同じ場合、名前でソート
                const aName = a.querySelector('p').textContent;
                const bName = b.querySelector('p').textContent;

                return aName.localeCompare(bName);
            });

            mainDeck.innerHTML = '';
            cardElements.forEach(element => mainDeck.appendChild(element));

            // デバッグ: ソート後のカード情報
            console.log('After sorting Main Deck:', Array.from(mainDeck.children).map(card => ({
                name: card.querySelector('p').textContent,
                type: card.dataset.type,
                level: card.dataset.level
            })));
        }

    </script>
    
</body>

</html>
